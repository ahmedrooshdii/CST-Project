<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sellers's orders</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"/>
         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
         <link rel="stylesheet" href="../../assets/css/bs/bootstrap.min.css">
    <link rel="stylesheet" href="../../assets/css/home.css">
  <link rel="stylesheet" href="css/style.css">
    <script src="../../assets/js/home.js" defer></script>
  <style>
</style>
</head>
<body class="bg-light">
    <header class="container-fluid d-md-flex justify-content-md-between">
    <div class="d-none d-md-flex gap-2">
             <a href="mailto:Mohamedbasiouny111@gmail.com"><i class="fa-solid fa-envelope"></i>Mohamedbasiouny111@gmail.com</a>
            <span>|</span>
            <a href="tel:01111514032"><i class="fa-solid fa-phone"></i></i>01111514032</a>
        </div>
        <div id="navbartop" class="d-flex flex-row-reverse justify-content-center text-uppercase gap-2 ">
            <a href="../../pages/auth/Register.html"><i class="fa-solid fa-user-plus"></i> Register</a>
            <span>|</span>
            <a href="../../pages/auth/login.html"><i class="fa-solid fa-arrow-right-to-bracket"></i> Login</a>
             <span>|</span>
            <a href="../../pages/auth/SellerRegister.html">Be a seller</a>
        </div>
  </header>
    <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar">
        <a class="navbar-brand" href="../../Home.html">
        <img
          style="width: 150px; height: 50px; margin-left: -.1vw"
          src="../../assets/images/logoLight.svg"
          alt="Logo"
        />
      </a>
      <ul>
        <li><a id ="dash" href="dashboard.html" class="nav-link">ðŸ“Š Dashboard</a></li>
        <li><a href="profile.html" class="nav-link">ðŸ‘¤ profile</a></li>
        <li><a id="usersPage" href="users.html" class="nav-link ">ðŸ‘¤ Users</a></li>
        <li><a href="orders.html" class="nav-link">ðŸ›’ Orders</a></li>
        <li><a id="sellerord" href="seller_orders.html" class="nav-link active">ðŸ›’ seller's Orders</a></li>
        <li><a id="product" href="products.html" class="nav-link">ðŸ›’ Products</a></li>
        <li><a id="cat" href="categories.html" class="nav-link">ðŸ‘¥ Categories</a></li>
        <li><a id ="contact" href="contactus.html" class="nav-link">ðŸ‘¥ Contact us</a></li>
      </ul>
      </div>

     <!-- Main Content -->
      <div class="col-md-10 content">
        <h2 class="mb-4">Seller's orders</h2>
        <!-- Filters -->
        <div class="row mb-3">
          <div class="col-md-4">
            <input type="text" class="form-control" placeholder="Search by customer or order ID" />
          </div>
          <div class="col-md-3">
            <select class="form-select">
              <option value="all">Status: All</option>
              <option value="pending">Pending</option>
              <option value="shipped">Shipped</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="date" class="form-control" />
          </div>
          <!-- Removed Filter Button Column -->
        </div>
        <div class="card shadow-sm">
          <div class="card-body">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>User name</th>
                  <th>Date</th>
                  <th>Seller's Total</th>
                  <th>Status</th>
                  <th>Availability</th>
                  <th>Detailes</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <tr>
                  <!-- <td>#1001</td>
                  <td>yasser</td>
                  <td>2025-08-10</td>
                  <td>$150.00</td>
                  <td><span class="badge bg-warning status-badge">Pending</span></td>
                  <td>
                    <button class="btn btn-sm btn-info" data-bs-toggle="offcanvas" data-bs-target="#orderDetails" onclick="loadOrderDetails('1001')">View</button>
                    <button class="btn btn-sm btn-success">Mark Shipped</button>
                  </td> -->
                </tr>
                <tr>
                  <!-- <td>#1002</td>
                  <td>ahmed</td>
                  <td>2025-08-09</td>
                  <td>$240.00</td>
                  <td><span class="badge bg-success status-badge">Completed</span></td>
                  <td>
                    <button class="btn btn-sm btn-info" data-bs-toggle="offcanvas" data-bs-target="#orderDetails" onclick="loadOrderDetails('1002')">View</button>
                  </td> -->
                </tr>
                <tr>
                  <!-- <td>#1003</td>
                  <td>mohamed</td>
                  <td>2025-08-08</td>
                  <td>$99.00</td>
                  <td><span class="badge bg-danger status-badge">Cancelled</span></td>
                  <td>
                    <button class="btn btn-sm btn-info" data-bs-toggle="offcanvas" data-bs-target="#orderDetails" onclick="loadOrderDetails('1003')">View</button>
                  </td> -->
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>
  <div class="offcanvas offcanvas-end" tabindex="-1" id="orderDetails">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Order Details</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <p><strong>Order ID:</strong> <span id="detailOrderId"></span></p>
      <p><strong>User name:</strong> <span id="detailCustomer"></span></p>
      <p><strong>Date-Time:</strong> <span id="detailDate"></span></p>
      <p><strong>Total:</strong> <span id="detailTotal"></span></p>
      <p><strong>Status:</strong> <span id="detailStatus"></span></p>
      <hr />
      <h6>Items</h6>
      <ul id="detailItems"></ul>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
window.addEventListener("load", function () {
  const user = JSON.parse(sessionStorage.getItem("currentUser"));
  if (!user || (user.role !== "seller" && user.role !== "admin")) {
    window.location.href = "../../pages/auth/login.html";
    return;
  }
});
// === SEARCH FILTER ===
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.querySelector('input[placeholder="Search by customer or order ID"]');
  const statusSelect = document.querySelector('select');
  const dateInput = document.querySelector('input[type="date"]');
  const pad = n => String(n).padStart(2, "0");
  function tableDateToYMD(raw) {
    if (!raw) return "";
    raw = raw.split(",")[0].trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
    const m = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) {
      const month = pad(m[1]);
      const day = pad(m[2]);
      const year = m[3];
      return `${year}-${month}-${day}`;
    }
    const d = new Date(raw);
    if (!isNaN(d)) {
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }
    return "";
  }
  function filterOrders() {
    const q = (searchInput?.value || "").trim().toLowerCase();
    const statusFilter = (statusSelect?.value || "all").toLowerCase();
    const dateFilter = (dateInput?.value || "");
    const rows = document.querySelectorAll("#ordersTableBody tr");
    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      if (cells.length === 0) return;
      const orderId = (cells[0].textContent || "").trim().replace(/^#/, "").toLowerCase();
      const customer = (cells[1].textContent || "").trim().toLowerCase();
      const rawDate = (cells[2].textContent || "").trim();
      const normalized = tableDateToYMD(rawDate);
      const status = (cells[4]?.textContent || "").trim().toLowerCase();
      const matchesSearch = !q || orderId.includes(q) || customer.includes(q);
      const matchesStatus = statusFilter === "all" || status.includes(statusFilter);
      const matchesDate = !dateFilter || (normalized === dateFilter);

      row.style.display = (matchesSearch && matchesStatus && matchesDate) ? "" : "none";
    });
  }
  searchInput?.addEventListener("input", filterOrders);
  statusSelect?.addEventListener("change", filterOrders);
  dateInput?.addEventListener("input", filterOrders);
  dateInput?.addEventListener("change", filterOrders);
  filterOrders();
  window._filterOrders = filterOrders;
});
// === ORDERS TABLE ===
document.addEventListener("DOMContentLoaded", function () {
  const orders = JSON.parse(localStorage.getItem("orders")) || [];
  const products = JSON.parse(localStorage.getItem("products")) || [];
  const users = JSON.parse(localStorage.getItem("users")) || [];
  const currentUser = JSON.parse(sessionStorage.getItem("currentUser")) || {};
  const tbody = document.getElementById("ordersTableBody");
  tbody.innerHTML = "";
  // get seller products if seller
  const sellerProducts = currentUser.role === "seller"
    ? products.filter(p => p.sellerEmail === currentUser.email)
    : [];
  const sellerProductIds = sellerProducts.map(p => String(p.id));
  // filter orders depending on role
  const visibleOrders = currentUser.role === "admin"
    ? orders
    : orders.filter(order =>
        order.items?.some(it => sellerProductIds.includes(String(it.productId)))
      );
  visibleOrders.forEach((order, index) => {
  let customer = "Unknown";
  const userMatch = users.find(u => u.addresses?.some(a => a.id === order.address?.id));
  if (userMatch) customer = userMatch.name;
  const date = order.time ? new Date(order.time).toLocaleDateString() : "-";
  // === Seller/Admin total ===
  let sellerTotal = 0;
  const sellerItems = currentUser.role === "admin"
    ? order.items
    : order.items.filter(it => sellerProductIds.includes(String(it.productId)));

  sellerItems.forEach(it => {
    const product = products.find(p => String(p.id) === String(it.productId));
    sellerTotal += (product?.price || 0) * it.quantity;
  });

  const displayTotal = "$" + sellerTotal.toFixed(2);

  // === Order status ===
  const status = order.status || "completed";
  let badgeClass = "bg-success";
  if (status === "pending") badgeClass = "bg-warning";
  else if (status === "cancelled") badgeClass = "bg-danger";
  else if (status === "shipped") badgeClass = "bg-primary";

  // === Product status (if multiple, join them) ===
  const productStatuses = sellerItems.map(it => {
    const product = products.find(p => String(p.id) === String(it.productId));
    return product?.status || "Unknown";
  });

  // For display â†’ if many products, show all statuses separated by commas
  const statusLabels = productStatuses.length
    ? productStatuses.map(st => {
        const cls = st === "Active" ? "bg-success" : "bg-danger";
        return `<span class="badge ${cls}">${st}</span>`;
      }).join(" ")
    : `<span class="badge bg-secondary">Unknown</span>`;

  // === Build row ===
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>#${order.id || index + 1}</td>
    <td>${customer}</td>
    <td>${date}</td>
    <td>${displayTotal}</td>
    <td><span class="badge ${badgeClass} status-badge">${status}</span></td>
    <td>${statusLabels}</td>
    <td>
      <button class="btn btn-sm btn-info" data-bs-toggle="offcanvas" 
              data-bs-target="#orderDetails" 
              onclick="loadOrderDetails('${order.id || index + 1}')">View</button>
    </td>
  `;
  tbody.appendChild(tr);
});
  // === Order details loader ===
  window.loadOrderDetails = function (orderId) {
    const order = orders.find(o => String(o.id) === String(orderId));
    if (!order) return;
    let customer = "Unknown";
    const userMatch = users.find(u => u.addresses?.some(a => a.id === order.address?.id));
    if (userMatch) customer = userMatch.name;
    document.getElementById("detailOrderId").textContent = "#" + order.id;
    document.getElementById("detailCustomer").textContent = customer;
    document.getElementById("detailDate").textContent = order.time;
    document.getElementById("detailStatus").textContent = order.status || "completed";
    const itemsUl = document.getElementById("detailItems");
    itemsUl.innerHTML = "";
    let detailTotal = 0;
    const filteredItems = currentUser.role === "admin"
      ? order.items
      : order.items.filter(it => sellerProductIds.includes(String(it.productId)));
    filteredItems.forEach(it => {
      const product = products.find(p => String(p.id) === String(it.productId));
      const linePrice = (product?.price || 0) * it.quantity;
      detailTotal += linePrice;
      const li = document.createElement("li");
      li.textContent = `${product ? product.name : "Unknown Product"} - Qty: ${it.quantity} - $${linePrice.toFixed(2)}`;
      itemsUl.appendChild(li);
    });
    document.getElementById("detailTotal").textContent = "$" + detailTotal.toFixed(2);
  };
});
</script>
</body>
</html>


<!--old code 
document.addEventListener("DOMContentLoaded", function () {
  const orders = JSON.parse(localStorage.getItem("orders")) || [];
  const products = JSON.parse(localStorage.getItem("products")) || [];
  const users = JSON.parse(localStorage.getItem("users")) || [];
  const currentUser = JSON.parse(sessionStorage.getItem("currentUser")) || {};

  const tbody = document.getElementById("ordersTableBody");
  tbody.innerHTML = ""; // clear demo rows

  orders.forEach((order, index) => {
    // Customer (fall back to session user if needed)
    let customer = currentUser.name || "Unknown";
    const userMatch = users.find(u => u.addresses?.some(a => a.id === order.address?.id));
    if (userMatch) customer = userMatch.name;

    // Format date from order.time
    const date = order.time ? new Date(order.time).toLocaleDateString() : "-";

    // Total
    const total = order.totalPrice || "$0.00";

    // Default status (you can extend this logic later)
    let status = order.status || "completed";
    let badgeClass = "bg-success";
    if (status === "pending") badgeClass = "bg-warning";
    else if (status === "cancelled") badgeClass = "bg-danger";
    else if (status === "shipped") badgeClass = "bg-primary";

    // Build row
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>#${order.id || index + 1}</td>
      <td>${customer}</td>
      <td>${date}</td>
      <td>${total}</td>
      <td><span class="badge ${badgeClass} status-badge">${status}</span></td>
      <td>
        <button class="btn btn-sm btn-info" data-bs-toggle="offcanvas" 
                data-bs-target="#orderDetails" 
                onclick="loadOrderDetails('${order.id || index + 1}')">View</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Details loader
  window.loadOrderDetails = function (orderId) {
    const order = orders.find(o => String(o.id) === String(orderId));
    if (!order) return;

    let customer = currentUser.name || "Unknown";
    const userMatch = users.find(u => u.addresses?.some(a => a.id === order.address?.id));
    if (userMatch) customer = userMatch.name;

    document.getElementById("detailOrderId").textContent = "#" + order.id;
    document.getElementById("detailCustomer").textContent = customer;
    document.getElementById("detailDate").textContent = order.time;
    document.getElementById("detailTotal").textContent = order.totalPrice;
    document.getElementById("detailStatus").textContent = order.status || "completed";

    const itemsUl = document.getElementById("detailItems");
    itemsUl.innerHTML = "";
    order.items.forEach(it => {
      const product = products.find(p => String(p.id) === String(it.productId));
      const li = document.createElement("li");
      li.textContent = `${product ? product.name : "Unknown Product"} - Qty: ${it.quantity} - Price: $${product ? product.price : "0"}`;
      itemsUl.appendChild(li);
    });
  };
}); -->